<style>
    .centeredButtons {
	margin: 0;
	position: absolute;
	top: 50%;
	left: 50%;
	-ms-transform: translate(-50%, -50%);
	transform: translate(-50%, -50%);
    }

    .buttons {
        width: 300px;
        height: 300px;
        font-size: large;
    }

    #b2 {
        background-color: aqua;
    }
    #p1{
        text-align: center;
        font-size: 32px;
    }
    #score{
        font-size: 32px;
    }
</style>




<!DOCTYPE html>
<html lang="en">
    <body>
        <div class="centeredButtons">
            <button id="b" class="buttons button1" onclick="unhideButton()">Click When Ready</button>
            <button id="b2" class="buttons button2" style="display:none" onclick="stopTimer()">Click!</button>
            <button id="Submit" style="display: none" onclick="submitScore()">Submit Score</button>
        </div>
        <p id="p1"></p>
        <p id="score"></p>
    </body>
</html>

<script>
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username');

        document.getElementById('p1').textContent = "Welcome back: " + username;

        var url = window.location.href;
        url = url.replace(/([&\?]password=)[^\&]+/, '');

        if (url !== window.location.href) {
                window.location.href = url;
        }

        //alert(username);
        //<!--- JMeter really doesn't like something about this script. -->
		//<!--- I'm not entirely sure what or why though... --->
		//<!--- Actually it's likely because this calls a route, but this route doesn't give a response --->
        fetch('/Request/Highscore?username=' + username)
        .then(response => 
        {
            if(!response.ok)
            {
                throw new Error("Error");
            }
            return response.text();
        })
        .then(data => {
            const highscore = parseInt(data);
            //alert(highscore);
            const scoreText = document.getElementById('score');
            scoreText.textContent = 'Highscore: ' + highscore;
        });

		
    }


    let startTime;
    function startTimer() {
        startTime = new Date().getTime();
        //alert("timer started");
    }
    function stopTimer() {

        const endTime = new Date().getTime();
        //alert("Alert 1");
        var time = endTime - startTime;
        //alert("Alert 2");
       
        var secondButton = document.getElementById('b2');
        
        secondButton.innerText = time.toLocaleString();
        secondButton.style.backgroundColor = 'forestgreen';

        document.getElementById('Submit').style.display = 'block';
        
    }

    function unhideButton() {
        document.getElementById('b').innerText = "Get Ready!";

        setTimeout(startGame, getNumberBetweenThreeAndSeven());

    }
    function startGame() {
        document.getElementById('b').style.display = 'none';
        document.getElementById('b2').style.display = 'block';
        startTimer();
    }

    function getNumberBetweenThreeAndSeven() {
        return (Math.random() * (7 - 3) + 1) * 1000;
    }
    function randomColors() {
        return '#' + Math.floor(Math.random() * 16777215).toString(16);
    }
    function submitScore() {        
        //what ever needs to be done to give score to Crow
        var url = window.location.href;
        
        url = url.replace(/([&\?]highscore=)[^\&]+/, '');
        var score = document.getElementById('b2').innerText;

        if (url.indexOf('?') !== -1) {
            url += '&highscore=' + score;
        } else {
            url += '?highscore=' + score;
        }


        const scoreText = document.getElementById('score').textContent;
        const halves = scoreText.split(':');
        const highScore = parseInt(halves[1].trim());

        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username');
        if(score < highScore)
        {
            fetch("/Event/UpdateScore",{
            method: "PATCH",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({username, score})
        })
            .then(response => {
                if(response.ok){

                    alert("Score Updated");
                }
                else{
                    alert("Incorrect Username or Password");
                }
        })
        }
        else
        {
            alert("Did not beat highscore.");
        }



        window.location.href = url;      
    }
</script>